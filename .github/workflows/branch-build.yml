# --------------------------------------------------------------------
#
# Build branches. Supports developer controls to skip various parts of
# the build. The following are the recognized keywords. Place anywhere
# within commit message. Multiple controls honored. Not case sensitive.
#
# [skip-all]
# [skip-compile-both]
# [skip-compile-debug]
# [skip-compile-prod]
# [skip-utest-both]
# [skip-utest-debug]
# [skip-utest-prod]
# [skip-analysis]
# [skip-coverage]
# [skip-docs]
#
# --------------------------------------------------------------------

name: Branch Build
run-name: Branch Build ${{ github.event.head_commit.message }}

on:
  push:
    branches-ignore:
      - main
      - master

permissions:
  contents: write
      
jobs:

  Build:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip-all]')"

    steps:
      - name: Install podman
        run: sudo apt install -y podman

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build debug
        if: "!contains(github.event.head_commit.message, '[skip-compile-both]') && \
             !contains(github.event.head_commit.message, '[skip-compile-debug]')"
        run: make debug

      - name: Run unit tests on debug
        if: "!contains(github.event.head_commit.message, '[skip-compile-both]') && \
             !contains(github.event.head_commit.message, '[skip-compile-debug]') && \
             !contains(github.event.head_commit.message, '[skip-compile-utest-both]') && \
             !contains(github.event.head_commit.message, '[skip-compile-utest-debug]')"
        run: make unit-test-debug

      - name: Build prod
        if: "!contains(github.event.head_commit.message, '[skip-compile-both]') && \
             !contains(github.event.head_commit.message, '[skip-compile-prod]')"
        run: make prod

      - name: Run unit tests on prod
        if: "!contains(github.event.head_commit.message, '[skip-compile-both]') && \
             !contains(github.event.head_commit.message, '[skip-compile-prod]') && \
             !contains(github.event.head_commit.message, '[skip-compile-utest-both]') && \
             !contains(github.event.head_commit.message, '[skip-compile-utest-prod]')"
        run: make unit-test-prod

      - name: Run static analysis
        if: "!contains(github.event.head_commit.message, '[skip-analysis]')"
        run: make static-analysis

      - name: Run code coverage
        if: "!contains(github.event.head_commit.message, '[skip-coverage]')"
        run: make code-coverage

      - name: Build docs
        if: "!contains(github.event.head_commit.message, '[skip-docs]')"
        run: make docs

# Experimenting
        
#      - name: Version label
#        id: version
#        run: |
#          echo "APP_NAME=redflame" >> $GITHUB_ENV
#          echo "APP_VERSION=v$(cat version)" >> $GITHUB_ENV
#          echo "APP_FULL=redflame-v1.0.0" >> $GITHUB_ENV
#          echo "APP_TAR=redflame-v1.0.0.tgz" >> $GITHUB_ENV
#
      - name: Create release tar ball
        id: tar-ball
        run: |
          APP_NAME=redflame
          APP_VERSION=v$(cat version)
          APP_NAME_FULL=${APP_NAME}-${APP_VERSION}
          D_REL=_build/release
          D_REL_FILES=${D_REL}/version/${APP_NAME_FULL}
          TAR_FILE=${D_REL}/${APP_NAME_FULL}.tgz
          mkdir -p ${D_REL_FILES}
          cp -p _build/prod/bin/${APP_NAME} ${D_REL_FILES}/
          tar -czf ${TAR_FILE} --directory=${D_REL_FILES}/.. .
          ls ${D_REL}
          echo "TAR_FILE=${TAR_FILE}"       >> ${GITHUB_OUT}
          echo "APP_VERSION=${APP_VERSION}" >> ${GITHUB_OUT}

      - name: Release actions
        env:
          TAR_FILE:    ${{ steps.tar-ball.outputs.TAR_FILE }}
          APP_VERSION: ${{ steps.tar-ball.outputs.APP_VERSION }}
        uses: softprops/action-gh-release@v2
        with:
          files: ${TAR_FILE}
          name: Release ${APP_VERSION}
          # if needed, you can set the release body here
          #body: "Release notes"
          draft: true
          prerelease: true
# 
#       - name: Upload release artifacts
#         uses: actions/upload-release-asset@v1
#         env:
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#         with:
#           upload_url: ${{ steps.release_actions.outputs.upload_url }}
#           asset_path: "_build/release/redflame-v1.0.0.tgz"
#           asset_name: "cpp-bootstrap-linux-${{ steps.version.outputs.name }}.tgz"
#           asset_content_type: application/x-tar

#    - name: download artifact
#      uses: actions/download-artifact@v2
#      with:
#        name: "Linux-${{ steps.version.outputs.name }}"
#        path: ./
#
#    - name: upload ubuntu release asset
#      uses: actions/upload-release-asset@v1
#      env:
#        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#      with:
#        upload_url: ${{ steps.create_release.outputs.upload_url }}
#        asset_path: "artifact.tar.gz"
#        asset_name: "${{ env.PROJECT_NAME }}-Linux-${{ steps.version.outputs.name }}.tar.gz"
#        asset_content_type: application/x-tar                  
